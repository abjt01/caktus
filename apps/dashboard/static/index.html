<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CAKTUS â€” Deploy Terminal</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=VT323&family=Share+Tech+Mono&display=swap');

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0a0a0a;
      --surface: #111111;
      --border: #1a3a1a;
      --text: #33ff33;
      --text-dim: #1a8a1a;
      --text-bright: #66ff66;
      --amber: #ffb000;
      --amber-dim: #8a6000;
      --red: #ff3333;
      --red-dim: #8a1a1a;
      --cyan: #00cccc;
      --white: #cccccc;
      --scanline: rgba(0, 0, 0, 0.15);
      --glow: 0 0 10px rgba(51, 255, 51, 0.3);
      --font-mono: 'Share Tech Mono', 'Courier New', monospace;
      --font-display: 'VT323', 'Courier New', monospace;
    }

    html { font-size: 14px; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-mono);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* CRT scanline overlay */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        var(--scanline) 2px,
        var(--scanline) 4px
      );
      pointer-events: none;
      z-index: 9999;
    }

    /* CRT screen curvature vignette */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: radial-gradient(ellipse at center, transparent 60%, rgba(0,0,0,0.6) 100%);
      pointer-events: none;
      z-index: 9998;
    }

    /* â”€â”€ Layout â”€â”€ */
    .shell {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 16px;
    }

    /* â”€â”€ Header â”€â”€ */
    .header {
      border-bottom: 1px solid var(--border);
      padding: 16px 0;
      text-align: center;
    }
    .header h1 {
      font-family: var(--font-display);
      font-size: 2.4rem;
      color: var(--text-bright);
      text-shadow: var(--glow);
      letter-spacing: 4px;
      margin-bottom: 4px;
    }
    .header .sub {
      color: var(--text-dim);
      font-size: 0.85rem;
      letter-spacing: 2px;
    }

    /* â”€â”€ Status Bar â”€â”€ */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
      font-size: 0.8rem;
      color: var(--text-dim);
      flex-wrap: wrap;
      gap: 8px;
    }
    .status-bar .dot {
      display: inline-block;
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--text);
      box-shadow: 0 0 6px var(--text);
      margin-right: 6px;
      animation: blink 2s infinite;
    }
    .status-bar .dot.off {
      background: var(--red);
      box-shadow: 0 0 6px var(--red);
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    .status-bar a {
      color: var(--cyan);
      text-decoration: none;
    }
    .status-bar a:hover { text-decoration: underline; }

    /* â”€â”€ Sections â”€â”€ */
    .section {
      margin-top: 24px;
    }
    .section-head {
      font-family: var(--font-display);
      font-size: 1.3rem;
      color: var(--amber);
      text-shadow: 0 0 8px rgba(255, 176, 0, 0.3);
      margin-bottom: 12px;
      letter-spacing: 2px;
    }
    .section-head::before {
      content: '> ';
      color: var(--text-dim);
    }

    /* â”€â”€ Deploy Form â”€â”€ */
    .deploy-form {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .deploy-form .full { grid-column: 1 / -1; }

    .field label {
      display: block;
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-bottom: 4px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .field input, .field textarea, .field select {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 0.9rem;
      padding: 8px 10px;
      outline: none;
      transition: border-color 0.2s;
    }
    .field input:focus, .field textarea:focus {
      border-color: var(--text);
      box-shadow: 0 0 8px rgba(51, 255, 51, 0.15);
    }
    .field input::placeholder, .field textarea::placeholder {
      color: #1a4a1a;
    }
    .field textarea {
      resize: vertical;
      min-height: 80px;
    }

    .mode-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 14px;
      grid-column: 1 / -1;
    }
    .mode-tab {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text-dim);
      font-family: var(--font-mono);
      font-size: 0.85rem;
      padding: 8px;
      cursor: pointer;
      text-align: center;
      letter-spacing: 1px;
      transition: all 0.2s;
    }
    .mode-tab:first-child { border-right: none; }
    .mode-tab.active {
      background: var(--border);
      color: var(--text-bright);
      text-shadow: var(--glow);
    }
    .mode-tab:hover:not(.active) { color: var(--text); }

    .btn-deploy {
      grid-column: 1 / -1;
      background: #0a2a0a;
      border: 1px solid var(--text);
      color: var(--text-bright);
      font-family: var(--font-display);
      font-size: 1.2rem;
      padding: 10px;
      cursor: pointer;
      letter-spacing: 3px;
      text-transform: uppercase;
      transition: all 0.2s;
      text-shadow: var(--glow);
    }
    .btn-deploy:hover {
      background: #0f3f0f;
      box-shadow: 0 0 20px rgba(51, 255, 51, 0.2);
    }
    .btn-deploy:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* â”€â”€ Terminal Log â”€â”€ */
    .terminal {
      background: var(--bg);
      border: 1px solid var(--border);
      padding: 12px;
      font-size: 0.8rem;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      margin-top: 14px;
    }
    .terminal.visible { display: block; }
    .terminal .line { margin: 2px 0; }
    .terminal .line.ok { color: var(--text); }
    .terminal .line.err { color: var(--red); }
    .terminal .line.info { color: var(--amber); }
    .terminal .line.url { color: var(--cyan); }

    /* â”€â”€ Apps Table â”€â”€ */
    .apps-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--surface);
      border: 1px solid var(--border);
    }
    .apps-table th {
      text-align: left;
      padding: 10px 12px;
      font-size: 0.75rem;
      color: var(--amber);
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 1px solid var(--border);
      font-weight: normal;
    }
    .apps-table td {
      padding: 10px 12px;
      font-size: 0.85rem;
      border-bottom: 1px solid #0f1f0f;
      vertical-align: middle;
    }
    .apps-table tr:last-child td { border-bottom: none; }
    .apps-table tr:hover td { background: #0a1a0a; }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.8rem;
    }
    .status-badge .indicator {
      width: 6px; height: 6px;
      border-radius: 50%;
    }
    .status-badge.running .indicator {
      background: var(--text);
      box-shadow: 0 0 6px var(--text);
    }
    .status-badge.stopped .indicator {
      background: var(--red);
      box-shadow: 0 0 6px var(--red);
    }
    .status-badge.unknown .indicator {
      background: var(--amber);
      box-shadow: 0 0 6px var(--amber);
    }

    .app-link {
      color: var(--cyan);
      text-decoration: none;
      font-size: 0.8rem;
    }
    .app-link:hover { text-decoration: underline; }

    .btn-sm {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-dim);
      font-family: var(--font-mono);
      font-size: 0.75rem;
      padding: 3px 8px;
      cursor: pointer;
      transition: all 0.15s;
      margin-left: 4px;
    }
    .btn-sm:hover {
      border-color: var(--text);
      color: var(--text);
    }
    .btn-sm.danger:hover {
      border-color: var(--red);
      color: var(--red);
    }

    .no-apps {
      text-align: center;
      padding: 30px;
      color: var(--text-dim);
      font-style: italic;
    }

    /* â”€â”€ Logs Modal â”€â”€ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 5000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.visible { display: flex; }
    .modal {
      background: var(--bg);
      border: 1px solid var(--text);
      width: 90%;
      max-width: 700px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 40px rgba(51, 255, 51, 0.1);
    }
    .modal-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
      color: var(--amber);
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 1.2rem;
      cursor: pointer;
      font-family: var(--font-mono);
    }
    .modal-close:hover { color: var(--red); }
    .modal-body {
      padding: 12px;
      overflow-y: auto;
      flex: 1;
      font-size: 0.75rem;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-all;
      color: var(--white);
    }

    /* â”€â”€ Footer â”€â”€ */
    .footer {
      border-top: 1px solid var(--border);
      padding: 16px 0;
      text-align: center;
      color: #0f3f0f;
      font-size: 0.75rem;
      letter-spacing: 2px;
      margin-top: 40px;
    }

    /* â”€â”€ Responsive â”€â”€ */
    @media (max-width: 600px) {
      .deploy-form { grid-template-columns: 1fr; }
      .header h1 { font-size: 1.6rem; }
      .status-bar { flex-direction: column; align-items: flex-start; }
    }

    /* CRT flicker */
    @keyframes flicker {
      0% { opacity: 0.97; }
      5% { opacity: 0.95; }
      10% { opacity: 0.98; }
      15% { opacity: 0.96; }
      20% { opacity: 0.99; }
      100% { opacity: 0.98; }
    }
    body { animation: flicker 4s infinite; }
  </style>
</head>
<body>

<div class="shell">

  <!-- â”€â”€ Header â”€â”€ -->
  <div class="header">
    <h1>ðŸŒµ CAKTUS</h1>
    <div class="sub">DEPLOY TERMINAL v2.0 &mdash; SELF-HOSTED INFRASTRUCTURE</div>
  </div>

  <!-- â”€â”€ Status Bar â”€â”€ -->
  <div class="status-bar">
    <span><span class="dot" id="sysDot"></span> SYSTEM <span id="sysStatus">CHECKING...</span></span>
    <span id="appCount">APPS: --</span>
    <span id="ngrokLink"></span>
    <span id="clockDisplay"></span>
  </div>

  <!-- â”€â”€ Deploy Section â”€â”€ -->
  <div class="section">
    <div class="section-head">DEPLOY NEW APPLICATION</div>

    <div class="deploy-form" id="deployForm">
      <!-- Mode selector -->
      <div class="mode-tabs">
        <button class="mode-tab active" onclick="setMode('image')" id="tabImage">DOCKER IMAGE</button>
        <button class="mode-tab" onclick="setMode('dockerfile')" id="tabDockerfile">DOCKERFILE</button>
      </div>

      <!-- Common fields -->
      <div class="field">
        <label>App Name</label>
        <input type="text" id="appName" placeholder="my-app" autocomplete="off" spellcheck="false">
      </div>
      <div class="field">
        <label>Container Port</label>
        <input type="number" id="appPort" placeholder="80" min="1" max="65535">
      </div>

      <!-- Image mode -->
      <div class="field full" id="imageField">
        <label>Image Name</label>
        <input type="text" id="appImage" placeholder="nginxdemos/hello" autocomplete="off" spellcheck="false">
      </div>

      <!-- Dockerfile mode (hidden by default) -->
      <div class="field full" id="dockerfileField" style="display:none;">
        <label>Dockerfile Content</label>
        <textarea id="appDockerfile" placeholder="FROM nginx:alpine&#10;COPY . /usr/share/nginx/html" rows="6"></textarea>
      </div>

      <!-- Env vars -->
      <div class="field full">
        <label>Environment Variables <span style="color:#1a4a1a">(one per line: KEY=VALUE)</span></label>
        <textarea id="appEnv" placeholder="NODE_ENV=production&#10;API_KEY=your-key-here" rows="3"></textarea>
      </div>

      <!-- Deploy button -->
      <button class="btn-deploy" id="btnDeploy" onclick="deploy()">[ DEPLOY ]</button>
    </div>

    <!-- Terminal output -->
    <div class="terminal" id="deployLog"></div>
  </div>

  <!-- â”€â”€ Running Apps â”€â”€ -->
  <div class="section">
    <div class="section-head">RUNNING APPLICATIONS</div>
    <div id="appsContainer">
      <div class="no-apps">Scanning containers...</div>
    </div>
  </div>

  <!-- â”€â”€ Footer â”€â”€ -->
  <div class="footer">
    CAKTUS DEPLOY TERMINAL &mdash; ONE LAPTOP. ZERO COST. FULLY MINE.
  </div>

</div>

<!-- â”€â”€ Logs Modal â”€â”€ -->
<div class="modal-overlay" id="logModal">
  <div class="modal">
    <div class="modal-head">
      <span id="logModalTitle">LOGS</span>
      <button class="modal-close" onclick="closeLogModal()">[X]</button>
    </div>
    <div class="modal-body" id="logModalBody">Loading...</div>
  </div>
</div>

<script>
// â”€â”€ State â”€â”€
let currentMode = 'image';
let polling = null;

// â”€â”€ Mode toggle â”€â”€
function setMode(mode) {
  currentMode = mode;
  document.getElementById('tabImage').classList.toggle('active', mode === 'image');
  document.getElementById('tabDockerfile').classList.toggle('active', mode === 'dockerfile');
  document.getElementById('imageField').style.display = mode === 'image' ? '' : 'none';
  document.getElementById('dockerfileField').style.display = mode === 'dockerfile' ? '' : 'none';
}

// â”€â”€ Clock â”€â”€
function updateClock() {
  const now = new Date();
  const ts = now.toLocaleTimeString('en-US', { hour12: false });
  document.getElementById('clockDisplay').textContent = ts;
}
setInterval(updateClock, 1000);
updateClock();

// â”€â”€ System Info â”€â”€
async function fetchInfo() {
  try {
    const r = await fetch('/api/health');
    if (r.ok) {
      document.getElementById('sysDot').classList.remove('off');
      document.getElementById('sysStatus').textContent = 'ONLINE';
    } else {
      throw new Error();
    }
  } catch {
    document.getElementById('sysDot').classList.add('off');
    document.getElementById('sysStatus').textContent = 'OFFLINE';
  }

  try {
    const r = await fetch('/api/info');
    const info = await r.json();
    const el = document.getElementById('ngrokLink');
    if (info.ngrok_url) {
      el.innerHTML = 'PUBLIC: <a href="' + info.ngrok_url + '" target="_blank">' + info.ngrok_domain + '</a>';
    } else {
      el.textContent = 'PUBLIC: NOT CONFIGURED';
    }
  } catch {}
}

// â”€â”€ Terminal Log â”€â”€
function termLog(msg, cls = 'ok') {
  const log = document.getElementById('deployLog');
  log.classList.add('visible');
  const line = document.createElement('div');
  line.className = 'line ' + cls;
  line.textContent = msg;
  log.appendChild(line);
  log.scrollTop = log.scrollHeight;
}

function clearLog() {
  const log = document.getElementById('deployLog');
  log.innerHTML = '';
  log.classList.remove('visible');
}

// â”€â”€ Deploy â”€â”€
async function deploy() {
  const name = document.getElementById('appName').value.trim().toLowerCase();
  const port = parseInt(document.getElementById('appPort').value) || 0;
  const image = document.getElementById('appImage').value.trim();
  const dockerfile = document.getElementById('appDockerfile').value;
  const envVars = document.getElementById('appEnv').value;

  if (!name) { alert('App name is required'); return; }
  if (!port) { alert('Port is required'); return; }
  if (currentMode === 'image' && !image) { alert('Image name is required'); return; }
  if (currentMode === 'dockerfile' && !dockerfile.trim()) { alert('Dockerfile content is required'); return; }

  const btn = document.getElementById('btnDeploy');
  btn.disabled = true;
  btn.textContent = '[ DEPLOYING... ]';
  clearLog();
  termLog('$ caktus deploy --name=' + name + ' --port=' + port, 'info');

  const body = {
    name: name,
    port: port,
    image: currentMode === 'image' ? image : null,
    dockerfile: currentMode === 'dockerfile' ? dockerfile : null,
    env_vars: envVars,
  };

  try {
    const r = await fetch('/api/deploy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const data = await r.json();

    if (data.log) {
      data.log.forEach(line => {
        let cls = 'ok';
        if (line.includes('[error]')) cls = 'err';
        else if (line.includes('[url]')) cls = 'url';
        else if (line.includes('[build]') || line.includes('[pull]')) cls = 'info';
        termLog(line, cls);
      });
    }

    if (data.success) {
      termLog('');
      termLog('âœ“ Deployment complete', 'ok');
      if (data.public_url) {
        termLog('â†’ ' + data.public_url, 'url');
      }
      // Clear form
      document.getElementById('appName').value = '';
      document.getElementById('appPort').value = '';
      document.getElementById('appImage').value = '';
      document.getElementById('appDockerfile').value = '';
      document.getElementById('appEnv').value = '';
      // Refresh app list
      fetchApps();
    } else {
      termLog('âœ— Deployment failed', 'err');
      if (data.error) termLog(data.error, 'err');
    }
  } catch (e) {
    termLog('âœ— Network error: ' + e.message, 'err');
  }

  btn.disabled = false;
  btn.textContent = '[ DEPLOY ]';
}

// â”€â”€ App List â”€â”€
async function fetchApps() {
  try {
    const r = await fetch('/api/apps');
    const apps = await r.json();

    document.getElementById('appCount').textContent = 'APPS: ' + apps.length;

    const container = document.getElementById('appsContainer');

    if (apps.length === 0) {
      container.innerHTML = '<div class="no-apps">No applications deployed. Use the form above to deploy one.</div>';
      return;
    }

    let html = '<table class="apps-table"><thead><tr>';
    html += '<th>NAME</th><th>STATUS</th><th>IMAGE</th><th>PORT</th><th>ACCESS</th><th>ACTIONS</th>';
    html += '</tr></thead><tbody>';

    apps.forEach(app => {
      const statusClass = app.status === 'running' ? 'running' : (app.status === 'exited' ? 'stopped' : 'unknown');
      const statusLabel = app.status.toUpperCase();

      html += '<tr>';
      html += '<td style="color:var(--text-bright);font-weight:bold;">' + esc(app.name) + '</td>';
      html += '<td><span class="status-badge ' + statusClass + '"><span class="indicator"></span>' + statusLabel + '</span></td>';
      html += '<td style="color:var(--text-dim);font-size:0.8rem;">' + esc(app.image) + '</td>';
      html += '<td>' + app.port + '</td>';
      html += '<td>';
      if (app.public_url) {
        html += '<a class="app-link" href="' + esc(app.public_url) + '" target="_blank">' + esc(app.public_url.replace('https://', '')) + '</a>';
      } else {
        html += '<a class="app-link" href="' + esc(app.local_url) + '" target="_blank">localhost</a>';
      }
      html += '</td>';
      html += '<td>';
      html += '<button class="btn-sm" onclick="showLogs(\'' + esc(app.name) + '\')" title="View logs">LOGS</button>';
      html += '<button class="btn-sm danger" onclick="deleteApp(\'' + esc(app.name) + '\')" title="Delete app">DEL</button>';
      html += '</td>';
      html += '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;

  } catch (e) {
    document.getElementById('appsContainer').innerHTML = '<div class="no-apps" style="color:var(--red)">Error fetching apps: ' + e.message + '</div>';
  }
}

// â”€â”€ Delete App â”€â”€
async function deleteApp(name) {
  if (!confirm('Delete app "' + name + '"? This will stop and remove the container.')) return;

  try {
    const r = await fetch('/api/apps/' + name, { method: 'DELETE' });
    const data = await r.json();
    if (data.success) {
      fetchApps();
    } else {
      alert('Failed to delete: ' + (data.error || 'unknown error'));
    }
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

// â”€â”€ Logs Modal â”€â”€
async function showLogs(name) {
  document.getElementById('logModal').classList.add('visible');
  document.getElementById('logModalTitle').textContent = 'LOGS â€” ' + name.toUpperCase();
  document.getElementById('logModalBody').textContent = 'Fetching logs...';

  try {
    const r = await fetch('/api/apps/' + name + '/logs?tail=200');
    const data = await r.json();
    document.getElementById('logModalBody').textContent = data.logs || '(no logs)';
  } catch (e) {
    document.getElementById('logModalBody').textContent = 'Error: ' + e.message;
  }
}

function closeLogModal() {
  document.getElementById('logModal').classList.remove('visible');
}

// Close modal on Escape
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeLogModal();
});

// â”€â”€ Utility â”€â”€
function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// â”€â”€ Init â”€â”€
fetchInfo();
fetchApps();
setInterval(fetchApps, 5000);
setInterval(fetchInfo, 15000);
</script>

</body>
</html>
