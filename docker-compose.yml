# ─────────────────────────────────────────────────────────────────────────────
# Project Caktus — docker-compose.yml
# All services run on the laptop. Caddy exposes port 80.
# Access via http://localhost or http://192.168.1.5
#
# Network: caktus-net (bridge, 172.20.0.0/16)
# Add new apps: bash scripts/add-app.sh <name> <port> <image:tag>
# ─────────────────────────────────────────────────────────────────────────────

networks:
  caktus-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

services:

  # ── ngrok Tunnel ───────────────────────────────────────────────────────────
  # Public HTTPS tunnel. Bypasses CG-NAT. No domain needed.
  # Free URL: https://your-static-domain.ngrok-free.app
  ngrok:
    image: ngrok/ngrok:latest
    container_name: caktus-ngrok
    command: http caktus-caddy:80 --url=${NGROK_DOMAIN}
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
    networks:
      - caktus-net
    restart: unless-stopped
    depends_on:
      - caddy

  # ── Caddy Reverse Proxy ───────────────────────────────────────────────────
  caddy:
    image: caddy:alpine
    container_name: caktus-caddy
    ports:
      - '80:80'
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - caktus-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:80"]
      interval: 30s
      timeout: 5s
      retries: 3

  # ── Portainer CE (Docker management UI) ──────────────────────────────────
  portainer:
    image: portainer/portainer-ce:latest
    container_name: caktus-portainer
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - caktus-net
    restart: unless-stopped

  # ── Uptime Kuma (monitoring + status page) ────────────────────────────────
  uptime-kuma:
    image: louislam/uptime-kuma:latest
    container_name: caktus-uptime
    volumes:
      - uptime_data:/app/data
    networks:
      - caktus-net
    restart: unless-stopped

  # ── Landing Page ──────────────────────────────────────────────────────────
  landing:
    image: nginx:alpine
    container_name: caktus-landing
    volumes:
      - ./apps/landing:/usr/share/nginx/html:ro
    networks:
      - caktus-net
    restart: unless-stopped

  # ── Hello World (smoke test) ──────────────────────────────────────────────
  hello:
    image: nginxdemos/hello
    container_name: caktus-hello
    networks:
      - caktus-net
    restart: unless-stopped

  # ── ADD YOUR APPS BELOW THIS LINE ─────────────────────────────────────────

volumes:
  caddy_data:
  caddy_config:
  portainer_data:
  uptime_data:
