# ─────────────────────────────────────────────────────────────────────────────
# Project Caktus — docker-compose.yml
# Network: caktus-net (172.20.0.0/16)
# ─────────────────────────────────────────────────────────────────────────────

networks:
  caktus-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"

services:

  # ── ngrok Tunnel ────────────────────────────────────────────────────────────
  ngrok:
    image: ngrok/ngrok:latest
    container_name: caktus-ngrok
    command: http caktus-nginx:80 --url=${NGROK_DOMAIN}
    environment:
      - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN}
    networks:
      - caktus-net
    restart: unless-stopped
    depends_on:
      nginx:
        condition: service_started
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:4040/api/tunnels" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging: *default-logging

  # ── nginx Reverse Proxy ──────────────────────────────────────────────────────
  nginx:
    image: nginx:alpine
    container_name: caktus-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/apps:/etc/nginx/apps:ro
    networks:
      - caktus-net
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost/nginx-health" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s
    logging: *default-logging

  # ── Dashboard (vintage terminal UI + deploy API) ──────────────────────────
  dashboard:
    build: ./apps/dashboard
    container_name: caktus-dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./nginx/apps:/nginx-apps
      - dashboard_data:/data
    environment:
      - NGINX_APPS_DIR=/nginx-apps
      - DATA_DIR=/data
      - NGROK_DOMAIN=${NGROK_DOMAIN}
    networks:
      - caktus-net
    restart: unless-stopped
    depends_on:
      nginx:
        condition: service_started
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:8000/api/health" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging: *default-logging

  # ── Portainer CE ─────────────────────────────────────────────────────────────
  portainer:
    image: portainer/portainer-ce:latest
    container_name: caktus-portainer
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - portainer_data:/data
    networks:
      - caktus-net
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:9000/api/status" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    logging: *default-logging

  # ── Uptime Kuma ──────────────────────────────────────────────────────────────
  uptime-kuma:
    image: louislam/uptime-kuma:latest
    container_name: caktus-uptime
    volumes:
      - uptime_data:/app/data
    networks:
      - caktus-net
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:3001" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    logging: *default-logging

  # ── Hello World (smoke test) ─────────────────────────────────────────────────
  hello:
    image: nginxdemos/hello
    container_name: caktus-hello
    networks:
      - caktus-net
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:80" ]
      interval: 30s
      timeout: 5s
      retries: 3
    logging: *default-logging
  # ── ADD YOUR APPS BELOW THIS LINE ────────────────────────────────────────────

volumes:
  portainer_data:
  uptime_data:
  dashboard_data:
