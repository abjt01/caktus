# ─────────────────────────────────────────────────────────────────────────────
# LAPTOP Caddyfile — ~/caktus/caddy/Caddyfile
#
# ROUTING DESIGN:
#   PUBLIC traffic (via ngrok):
#     Host: <your-ngrok-domain>.ngrok-free.app → landing page (default)
#     Management tools (portainer, uptime-kuma) are intentionally NOT public.
#     To expose a user-facing app publicly, add a path-based route under @public.
#
#   LOCAL traffic (LAN / /etc/hosts):
#     Add entries to /etc/hosts for subdomain routing:
#       127.0.0.1 caktus.local portainer.caktus.local status.caktus.local hello.caktus.local
#     Then access via http://portainer.caktus.local etc.
# ─────────────────────────────────────────────────────────────────────────────

{
    auto_https off
    admin off
}

:80 {

    # ── Local subdomain routing (LAN / /etc/hosts only) ──────────────────────

    @landing host caktus.local
    handle @landing {
        reverse_proxy caktus-landing:80
    }

    @hello host hello.caktus.local
    handle @hello {
        reverse_proxy caktus-hello:80
    }

    @portainer host portainer.caktus.local
    handle @portainer {
        reverse_proxy caktus-portainer:9000
    }

    @uptime host status.caktus.local
    handle @uptime {
        reverse_proxy caktus-uptime:3001
    }

    # ── Public path routing (accessible via ngrok URL) ────────────────────────
    # Uncomment and adapt to expose a specific app publicly via /path prefix.
    # Example: https://your-ngrok-domain.ngrok-free.app/myapp → caktus-myapp:3000
    #
    # @myapp-public path_regexp ^/myapp(/.*)?$
    # handle @myapp-public {
    #     uri strip_prefix /myapp
    #     reverse_proxy caktus-myapp:3000
    # }

    # ── Harbor RPC proxies (public + LAN) ────────────────────────────────────
    # These path routes work on any host (ngrok domain or harbor.caktus.local)
    # Browser uses window.location.origin so the correct host is automatic.
    handle /rpc/fortress* {
        uri strip_prefix /rpc/fortress
        reverse_proxy caktus-harbor-fortress:8545
    }
    handle /rpc/smallchain* {
        uri strip_prefix /rpc/smallchain
        reverse_proxy caktus-harbor-smallchain:8546
    }

    # ── Harbor (LAN: harbor.caktus.local) ────────────────────────────────────
    @harbor host harbor.caktus.local
    handle @harbor {
        reverse_proxy caktus-harbor-frontend:80
    }

    # ── Default catch-all → Harbor frontend (public via ngrok) ───────────────
    handle {
        reverse_proxy caktus-harbor-frontend:80
    }
}
