events {
    worker_connections 1024;
}

http {
    include      /etc/nginx/mime.types;
    default_type application/octet-stream;
    sendfile     on;

    # Docker internal DNS — resolves container names dynamically
    resolver 127.0.0.11 valid=10s ipv6=off;

    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    proxy_http_version  1.1;
    proxy_set_header    Host               $host;
    proxy_set_header    X-Real-IP          $remote_addr;
    proxy_set_header    X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header    X-Forwarded-Proto  $scheme;
    proxy_set_header    Upgrade            $http_upgrade;
    proxy_set_header    Connection         $connection_upgrade;

    # ── LAN-only management tools ─────────────────────────────────────────────

    server {
        listen 80;
        server_name portainer.caktus.local;
        location / {
            set $upstream caktus-portainer:9000;
            proxy_pass http://$upstream;
        }
    }

    server {
        listen 80;
        server_name status.caktus.local;
        location / {
            set $upstream caktus-uptime:3001;
            proxy_pass http://$upstream;
        }
    }

    server {
        listen 80;
        server_name hello.caktus.local;
        location / {
            set $upstream caktus-hello:80;
            proxy_pass http://$upstream;
        }
    }

    # ── ADD NEW APP ROUTES ABOVE THIS LINE ───────────────────────────────────

    # ── Default server (public via ngrok + LAN) ───────────────────────────────

    server {
        listen 80 default_server;
        server_name _;

        location = /nginx-health {
            access_log off;
            return 200 "ok\n";
            add_header Content-Type text/plain;
        }

        include /etc/nginx/apps/*.conf;

        location / {
            set $upstream caktus-dashboard:8000;
            proxy_pass http://$upstream;
        }
    }
}
